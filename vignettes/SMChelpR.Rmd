---
title: "SMChelpR"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{my-vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

In dieser Vignette möchten wir Ihnen die Funktionalität des SMChelpR-Pakets vorstellen, welches erforderlich ist, damit von uns bereitgestellter Programmcode funktioniert. 
Dieses Paket dient vornehmlich der Bereitstellung von Funktionalität und Einstellung von Parametern bzgl. der Grafik-Gestaltung unserer Datenreports. 

Relevante Einstellungen werden in R Markdown oder Quarto über die YAML-Parameter zu Beginn des Dokuments gegeben. Unsere Grafiken sind dabei auf folgende Einstellungen optimiert, insbesondere Abweichungen in den dpi werden zu sehr anderen Resultaten führen. 
Der Parameter `results = 'asis'` ist für die Funktion `image_helper()` erforderlich, welche wir für das Erstellen von Bildunterschriften nutzen.

```{r}
knitr::opts_chunk$set(
  results = 'asis',
  fig.width = 9, 
  fig.height = 8.5, 
  dpi = 300
)
``` 

Beim Laden des Pakets SMChelpR werden direkt auch die Pakete `showtext`,	`ggplot2`, `plotly`, `sysfonts` und `fs` geladen, da die Funktionalität andernfalls nicht gewährleistet werden kann. Für diese Vignette ist aufgrund der Datenauswertung außerdem das `tidyverse` erforderlich.

```{r setup, results = 'hide', warning = FALSE, message = FALSE}
library(SMChelpR)
library(tidyverse)
```

Zu Beginn eines jeden Dokuments setzen wir einige Parameter:

- Der Aufruf von `SMC_theme_ggplot()` setzt viele `ggplot`- und `ggplotly`-Parameter, die das allgemeine Aussehen der Abbildungen einstellen.
- Es werden eine oder mehrere Bildunterschriften (captions) eingestellt, die etwa Herkunft über die für eine Abbildung verwendete Datenquellen geben.
  * Man beachte: für `ggplot` müssen Zeilenumbrüche im String als `\n` kodiert werden, für `image_helper()` jedoch als `<br>`.
- Es wird ein Zielordner zum Abspeichern von Daten und Abbildungen, die wir als Download anbieten möchten, angegeben.

```{r initalise-graphics}
SMChelpR::SMC_theme_ggplot()

caption_demo <- 
  "Dies ist eine Demo für die Darstellung von Daten mit dem SMChelpR-Paket. \nDie Daten sind frei erfunden und haben keinen Bezug zur Realität. \nBerechnungen: Science Media Center Germany."

filepath <-
  file.path("Beispieldaten")
```

Für diese Vignette verwenden wir einen kleinen Beispieldatensatz, der für das Jahr 1701 zwei Datenreihen mit Zufallsdaten (ein Eintrag pro Woche) enthält. 

```{r load-data, results = 'hide', warning = FALSE, message = FALSE}
set.seed(42) # Konstanter Seed für Reproduzierbarkeit

Beispieldaten <- tibble(
  Datum = rep(
    seq.Date(
      from = as.Date("1701-01-01"), 
      to = as.Date("1701-12-31"), 
      by = "week"
    ),
    2
  ),
  Reihe = c(rep("Zufallsreihe I", 53), rep("Zufallsreihe II", 53)),
  Wert = runif(2*53)
)
```

Anschließend können wir eine erste Abbildung mit `ggplot` erstellen. Hierbei ist `SMChelpR` nur im Hintergrund durch `SMC_theme_ggplot()` aktiv.

```{r lineplot, eval = FALSE}
Abbildung <- ggplot(Beispieldaten, aes(x = Datum, y = Wert, colour = Reihe)) +
  geom_line() +
  geom_point() +
  scale_x_date(
    date_breaks = "1 month", 
    date_labels = "%b", 
    expand = c(0.01, 0.01)
  ) +
  scale_y_continuous(
    expand = c(0.01, 0.01)
  ) +
  labs(
    title = "Abbildung mit zufallsgenerierten Daten",
    subtitle = "In ggplot kann man einen Untertitel nutzen.",
    caption = caption_demo,
    x = "Monat des Jahres 1701", 
    y = "Zufallszahlen ohne Einheit"
  ) 
``` 

Würde man diese Abbildung im dynamischen Dokument nur durch Aufruf von `Abbildung` zeigen, würde bspw. die Schriftgröße falsch angezeigt. Wenn dies jedoch vorher mit `ggsave()` gesichert wird, sind alle Einstellungen korrekt. Dieses Abspeichern wir durch `image_helper()` automatisch im Hintergrund erledigt. Dies zeigt dann eine der abgespeicherten PNGs an und erstellt auch gleich die Bildunterschrift. 

Die Daten, welche zu einer Abbildung gehören und als Download zur Verfügung gestellt werden sollen, müssen manuell an den korrekten Platz gespeichert werden, für die Abbildungen geschieht dies automatisch.

```{r image_helper-demonstration, eval = FALSE}
dateiname <- "Zufallsdaten"
write_csv(Beispieldaten, file.path(filepath, paste0(dateiname, ".csv")))

image_helper(
  Abbildung,
  filename = dateiname,
  filepath = filepath,
  plotly = FALSE
)
``` 

Nun nutzen wir eine `SMChelpR` Funktion, um direkt eine passende plotly-Abbildung hieraus zu erstellen und anzuzeigen. Die Funktion `ggplotly_SMC()` passt hierbei das Layout nochmal an, da `plotly` DPI anders zu interpretieren scheint als `ggplot`.

Die `image_helper()` Fuktion muss nun so eingestellt werden, dass die gespeicherten PNGs nicht angezeigt werden und die Plotly-Abbildung muss manuell angezeigt werden.

```{r lineplot-plotly, eval = FALSE}
Abbildung_plotly <- ggplotly_SMC(Abbildung)
Abbildung_plotly
```
```{r, eval = FALSE}
image_helper(
  Abbildung,
  filename = dateiname,
  filepath = filepath,
  plotly = TRUE,
  caption = paste("Die Abbildung wurde mit plotly erstellt, sodass einige ggplot Features wie Untertitel oder Bildunterschriften nicht mehr verfügbar sind. Entpsrechend müssten entsprechende captions jetzt hier eingefügt werden.")
)
```